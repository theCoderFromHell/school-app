name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [opened, synchronize, reopened]
  push:
    branches: [ main, master, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Compile
      run: ./gradlew clean compileJava compileTestJava --info

    - name: Run Tests
      run: ./gradlew test --info

    - name: Build JAR
      run: ./gradlew build -x test --info

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results
        path: build/test-results/
        retention-days: 30

    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-reports
        path: build/reports/tests/
        retention-days: 30

    - name: Publish Test Results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: 'build/test-results/test/TEST-*.xml'
        check_name: 'JUnit Test Results'

    - name: Generate Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: JUnit Tests
        path: 'build/test-results/test/TEST-*.xml'
        reporter: 'java-junit'
        fail-on-error: true

    - name: Check Test Coverage (Optional)
      if: always()
      run: |
        echo "Test Results Summary:"
        find build/test-results/test -name "TEST-*.xml" -exec sh -c 'echo "File: $1"; grep -o "tests=\"[^\"]*\"" "$1"' _ {} \;

    - name: Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: build/
        retention-days: 7

    - name: Set build status in PR
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const jobStatus = '${{ job.status }}';
          const isSuccess = jobStatus === 'success';
          
          const buildStatus = {
            '✅ BUILD PASSED': 'All checks passed',
            '❌ BUILD FAILED': 'Build or tests failed'
          };
          
          const emoji = isSuccess ? '✅' : '❌';
          const statusText = isSuccess ? 'PASSED' : 'FAILED';
          
          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} CI/CD Pipeline ${statusText}\n\n**Build Status**: ${statusText}\n\nView the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`
            });
          }

